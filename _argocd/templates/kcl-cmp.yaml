# https://raw.githubusercontent.com/kcl-lang/kcl-lang.io/main/examples/gitops/install/kcl-cmp.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kcl-plugin-config
  namespace: argocd
data:
  # Sometimes, the ArgoCD runs the kcl run command twice simultaneously,
  # leading to a race condition in the usage of files inside the
  # KCL_CACHE_PATH and KCL_PKG_PATH directories.
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: kcl
    spec:
      version: v1.0
      parameters:
        static:
          - name: "config_files"
            title: "Configuration Files"
            tooltip: "Comma-separated list of YAML configuration files to include"
            required: false
            itemType: "value"
      generate:
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            export KCL_CACHE_PATH=/tmp
            export KCL_PKG_PATH=/tmp
            KCL_CMD="kcl run main.k"
            if [ -n "$ARGOCD_ENV_config_files" ]; then
              IFS=',' read -ra FILES <<< "$ARGOCD_ENV_config_files"
              for file in "${FILES[@]}"; do
                file=$(echo "$file" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                if [ -f "$file" ]; then
                  KCL_CMD="$KCL_CMD -Y $file"
                fi
              done
            fi
            echo "Directory: $(pwd)" >&2
            echo "Executing: $KCL_CMD" >&2
            eval "$KCL_CMD"
